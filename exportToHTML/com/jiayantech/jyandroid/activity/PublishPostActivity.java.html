<html>
<head>
<title>PublishPostActivity.java</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.ln { color: rgb(0,0,0); font-weight: normal; font-style: normal; }
.s0 { color: rgb(204,120,50); }
.s1 { color: rgb(169,183,198); }
.s2 { color: rgb(98,151,85); font-style: italic; }
.s3 { color: rgb(98,151,85); font-weight: bold; font-style: italic; }
.s4 { color: rgb(104,151,187); }
.s5 { color: rgb(106,135,89); }
.s6 { color: rgb(128,128,128); }
</style>
</head>
<BODY BGCOLOR="#2b2b2b">
<TABLE CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#C0C0C0" >
<TR><TD><CENTER>
<FONT FACE="Arial, Helvetica" COLOR="#000000">
PublishPostActivity.java</FONT>
</center></TD></TR></TABLE>
<pre>

<span class="s0">package </span><span class="s1">com.jiayantech.jyandroid.activity</span><span class="s0">;</span><span class="s1"> 
 
</span><span class="s0">import </span><span class="s1">android.app.Dialog</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.content.Intent</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.graphics.Bitmap</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.os.Bundle</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.support.v7.widget.GridLayoutManager</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.support.v7.widget.RecyclerView</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.text.TextUtils</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.view.LayoutInflater</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.view.Menu</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.view.MenuItem</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.view.View</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.widget.EditText</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.widget.ImageView</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">android.widget.TextView</span><span class="s0">;</span><span class="s1"> 
 
</span><span class="s0">import </span><span class="s1">com.android.volley.VolleyError</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.jyandroid.R</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.jyandroid.adapter.ImageAdapter</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.jyandroid.biz.TopicBiz</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.jyandroid.biz.UploadImageBiz</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.jyandroid.commons.Broadcasts</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.jyandroid.model.ImageUploadResp</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.jyandroid.model.AppInit</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.jyandroid.widget.ItemsLayout</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.library.base.BaseActivity</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.library.base.BaseModel</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.library.base.BaseSimpleModelAdapter</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.library.comm.ActivityResult</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.library.comm.PicGetter</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.library.helper.BroadcastHelper</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.library.http.AppResponse</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.library.http.HttpConfig</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.library.http.ResponseListener</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.library.utils.DialogUtils</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">com.jiayantech.library.utils.ToastUtil</span><span class="s0">;</span><span class="s1"> 
 
</span><span class="s0">import </span><span class="s1">java.io.File</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">java.util.ArrayList</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">java.util.Iterator</span><span class="s0">;</span><span class="s1"> 
</span><span class="s0">import </span><span class="s1">java.util.List</span><span class="s0">;</span><span class="s1"> 
 
 
</span><span class="s2">/** 
 * Created by janseon on 2015/6/30. 
 * 
 * </span><span class="s3">@Description:</span><span class="s2"> 
 * </span><span class="s3">@Copyright: </span><span class="s2">Copyright (c) 2015 Shenzhen Jiayan Tech Co., Ltd. Inc. All 
 * rights reserved. 
 */</span><span class="s1"> 
</span><span class="s0">public class </span><span class="s1">PublishPostActivity </span><span class="s0">extends </span><span class="s1">BaseActivity </span><span class="s0">implements </span><span class="s1">View.OnClickListener</span><span class="s0">, </span><span class="s1">PicGetter.PicGetListener</span><span class="s0">, </span><span class="s1">BaseSimpleModelAdapter.OnItemClickListener&lt;Bitmap&gt; { 
    </span><span class="s0">private final int </span><span class="s1">spanCount = </span><span class="s4">4</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private final </span><span class="s1">String UPLOAD_TYPE_TOPIC = </span><span class="s5">&quot;topic&quot;</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">protected </span><span class="s1">String UPLOAD_TYPE = UPLOAD_TYPE_TOPIC</span><span class="s0">;</span><span class="s1"> 
 
    </span><span class="s0">protected </span><span class="s1">RecyclerView recycler_view</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">protected </span><span class="s1">ImageView img_photo</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">protected </span><span class="s1">EditText edit_content</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">protected </span><span class="s1">TextView txt_category</span><span class="s0">;</span><span class="s1"> 
 
    </span><span class="s0">protected </span><span class="s1">ImageAdapter mImageAdapter</span><span class="s0">;</span><span class="s1"> 
    </span><span class="s0">private </span><span class="s1">List&lt;AppInit.Category&gt; categoryList</span><span class="s0">;</span><span class="s1"> 
 
    @Override 
    </span><span class="s0">protected void </span><span class="s1">onCreate(Bundle savedInstanceState) { 
        </span><span class="s0">super</span><span class="s1">.onCreate(savedInstanceState)</span><span class="s0">;</span><span class="s1"> 
        setContentView(R.layout.activity_publish_post)</span><span class="s0">;</span><span class="s1"> 
        findViews()</span><span class="s0">;</span><span class="s1"> 
        setViewsContent()</span><span class="s0">;</span><span class="s1"> 
        setViewsListener()</span><span class="s0">;</span><span class="s1"> 
    } 
 
    </span><span class="s0">protected void </span><span class="s1">findViews() { 
        recycler_view = (RecyclerView) findViewById(R.id.recycler_view)</span><span class="s0">;</span><span class="s1"> 
        img_photo = (ImageView) findViewById(R.id.img_photo)</span><span class="s0">;</span><span class="s1"> 
        edit_content = (EditText) findViewById(R.id.edit_content)</span><span class="s0">;</span><span class="s1"> 
        txt_category = (TextView) findViewById(R.id.txt_category)</span><span class="s0">;</span><span class="s1"> 
    } 
 
    </span><span class="s0">protected void </span><span class="s1">setViewsContent() { 
        setTitle(R.string.title_publish_topic)</span><span class="s0">;</span><span class="s1"> 
        mImageAdapter = </span><span class="s0">new </span><span class="s1">ImageAdapter(</span><span class="s0">null</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        recycler_view.setLayoutManager(</span><span class="s0">new </span><span class="s1">GridLayoutManager(</span><span class="s0">this, </span><span class="s1">spanCount))</span><span class="s0">;</span><span class="s1"> 
    } 
 
    </span><span class="s0">protected void </span><span class="s1">setViewsListener() { 
        mImageAdapter.setOnItemClickListener(</span><span class="s0">this</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        txt_category.setOnClickListener(</span><span class="s0">this</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        mImageAdapter.resetGridHeight(recycler_view</span><span class="s0">, </span><span class="s1">spanCount)</span><span class="s0">;</span><span class="s1"> 
    } 
 
    @Override 
    </span><span class="s0">public boolean </span><span class="s1">onCreateOptionsMenu(Menu menu) { 
        getMenuInflater().inflate(R.menu.publish_action</span><span class="s0">, </span><span class="s1">menu)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">return true;</span><span class="s1"> 
    } 
 
    @Override 
    </span><span class="s0">public boolean </span><span class="s1">onOptionsItemSelected(MenuItem item) { 
        </span><span class="s0">switch </span><span class="s1">(item.getItemId()) { 
            </span><span class="s0">case </span><span class="s1">android.R.id.home: 
                onBackPressed()</span><span class="s0">;</span><span class="s1"> 
                </span><span class="s0">return true;</span><span class="s1"> 
            </span><span class="s0">case </span><span class="s1">R.id.action_publish: 
                String content = edit_content.getText().toString()</span><span class="s0">;</span><span class="s1"> 
                </span><span class="s0">if </span><span class="s1">(TextUtils.isEmpty(content)) { 
                    ToastUtil.showMessage(</span><span class="s5">&quot;input content&quot;</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
                    </span><span class="s0">return true;</span><span class="s1"> 
                } 
                uploadImage(</span><span class="s4">0</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
                finish()</span><span class="s0">;</span><span class="s1"> 
                </span><span class="s0">return true;</span><span class="s1"> 
        } 
        </span><span class="s0">return super</span><span class="s1">.onOptionsItemSelected(item)</span><span class="s0">;</span><span class="s1"> 
    } 
 
    </span><span class="s0">private void </span><span class="s1">post() { 
        String content = edit_content.getText().toString()</span><span class="s0">;</span><span class="s1"> 
        onPost(content)</span><span class="s0">;</span><span class="s1"> 
    } 
 
    @Override 
    </span><span class="s0">public void </span><span class="s1">onClick(View v) { 
        </span><span class="s0">switch </span><span class="s1">(v.getId()) { 
            </span><span class="s0">case </span><span class="s1">R.id.txt_category: 
                startActivityForResult(</span><span class="s0">new </span><span class="s1">Intent(</span><span class="s0">this, </span><span class="s1">SelectCategoryActivity.</span><span class="s0">class</span><span class="s1">)</span><span class="s0">, new </span><span class="s1">ActivityResult() { 
                    @Override 
                    </span><span class="s0">public void </span><span class="s1">onActivityResult(</span><span class="s0">int </span><span class="s1">requestCode</span><span class="s0">, int </span><span class="s1">resultCode</span><span class="s0">, </span><span class="s1">Intent data) { 
                        categoryList = data.getParcelableArrayListExtra(SelectCategoryActivity.KEY_categories)</span><span class="s0">;</span><span class="s1"> 
                        txt_category.setText(AppInit.Category.toNamesString(categoryList))</span><span class="s0">;</span><span class="s1"> 
                    } 
                })</span><span class="s0">;</span><span class="s1"> 
                </span><span class="s0">break;</span><span class="s1"> 
        } 
    } 
 
    </span><span class="s0">protected void </span><span class="s1">onPost(String content) { 
        </span><span class="s0">if </span><span class="s1">(categoryList == </span><span class="s0">null </span><span class="s1">|| categoryList.size() &lt;= </span><span class="s4">0</span><span class="s1">) { 
            ToastUtil.showMessage(</span><span class="s5">&quot;categoryIds null&quot;</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
            </span><span class="s0">return;</span><span class="s1"> 
        } 
        showProgressDialog()</span><span class="s0">;</span><span class="s1"> 
        String categoryIds = categoryList.toString()</span><span class="s0">;</span><span class="s1"> 
        String photoUrls = toString(mImageAdapter.urlList)</span><span class="s0">;</span><span class="s1"> 
        TopicBiz.create(categoryIds</span><span class="s0">, </span><span class="s1">content</span><span class="s0">, </span><span class="s1">photoUrls</span><span class="s0">, new </span><span class="s1">ResponseListener&lt;AppResponse&lt;BaseModel&gt;&gt;() { 
            @Override 
            </span><span class="s0">public void </span><span class="s1">onResponse(AppResponse&lt;BaseModel&gt; response) { 
                </span><span class="s6">//dismissProgressDialog();</span><span class="s1"> 
                BroadcastHelper.send(Broadcasts.ACTION_PUBLISH_TOPIC)</span><span class="s0">;</span><span class="s1"> 
                </span><span class="s6">//finish();</span><span class="s1"> 
            } 
        })</span><span class="s0">;</span><span class="s1"> 
    } 
 
    </span><span class="s0">protected </span><span class="s1">String toString(List&lt;String&gt; urlList) { 
        </span><span class="s0">if </span><span class="s1">(urlList.isEmpty()) { 
            </span><span class="s0">return </span><span class="s5">&quot;[]&quot;</span><span class="s0">;</span><span class="s1"> 
        } 
 
        StringBuilder buffer = </span><span class="s0">new </span><span class="s1">StringBuilder(urlList.size() * </span><span class="s4">16</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        buffer.append(</span><span class="s5">'['</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        Iterator&lt;?&gt; it = urlList.iterator()</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">while </span><span class="s1">(it.hasNext()) { 
            Object next = it.next()</span><span class="s0">;</span><span class="s1"> 
            </span><span class="s0">if </span><span class="s1">(next != </span><span class="s0">this</span><span class="s1">) { 
                buffer.append(</span><span class="s5">&quot;</span><span class="s0">\&quot;</span><span class="s5">&quot;</span><span class="s1">).append(next).append(</span><span class="s5">&quot;</span><span class="s0">\&quot;</span><span class="s5">&quot;</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
            } </span><span class="s0">else </span><span class="s1">{ 
                buffer.append(</span><span class="s5">&quot;(this Collection)&quot;</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
            } 
            </span><span class="s0">if </span><span class="s1">(it.hasNext()) { 
                buffer.append(</span><span class="s5">&quot;, &quot;</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
            } 
        } 
        buffer.append(</span><span class="s5">']'</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">return </span><span class="s1">buffer.toString()</span><span class="s0">;</span><span class="s1"> 
    } 
 
    </span><span class="s2">/** 
     * 选择照片后的回调接口的实现 
     */</span><span class="s1"> 
    @Override 
    </span><span class="s0">public void </span><span class="s1">onPicGet(String path</span><span class="s0">, </span><span class="s1">Bitmap bitmap) { 
</span><span class="s6">//        mImageAdapter.addImage(bitmap);</span><span class="s1"> 
</span><span class="s6">//        mImageAdapter.resetViewHeight(recycler_view, spanCount);</span><span class="s1"> 
</span><span class="s6">//        mSelectPath</span><span class="s1"> 
        </span><span class="s0">if</span><span class="s1">(mSelectPath == </span><span class="s0">null</span><span class="s1">){ 
            mSelectPath = </span><span class="s0">new </span><span class="s1">ArrayList&lt;&gt;()</span><span class="s0">;</span><span class="s1"> 
        } 
        mSelectPath.add(path)</span><span class="s0">;</span><span class="s1"> 
        mImageAdapter.addImage(bitmap)</span><span class="s0">;</span><span class="s1"> 
        mImageAdapter.resetViewHeight(recycler_view</span><span class="s0">, </span><span class="s1">spanCount)</span><span class="s0">;</span><span class="s1"> 
</span><span class="s6">//        showProgressDialog();</span><span class="s1"> 
</span><span class="s6">//        UploadImageBiz.uploadImage(UPLOAD_TYPE, bitmap, new File(path).getName(),</span><span class="s1"> 
</span><span class="s6">//                new ResponseListener&lt;ImageUploadResp&gt;() {</span><span class="s1"> 
</span><span class="s6">//                    @Override</span><span class="s1"> 
</span><span class="s6">//                    public void onResponse(ImageUploadResp o) {</span><span class="s1"> 
</span><span class="s6">//                        dismissProgressDialog();</span><span class="s1"> 
</span><span class="s6">//                        mImageAdapter.urlList.add(HttpConfig.IMAGE_SHOW_URL + o.url);</span><span class="s1"> 
</span><span class="s6">//                    }</span><span class="s1"> 
</span><span class="s6">//</span><span class="s1"> 
</span><span class="s6">//                    @Override</span><span class="s1"> 
</span><span class="s6">//                    public void onErrorResponse(VolleyError error) {</span><span class="s1"> 
</span><span class="s6">//                        dismissProgressDialog();</span><span class="s1"> 
</span><span class="s6">//                        super.onErrorResponse(error);</span><span class="s1"> 
</span><span class="s6">//                    }</span><span class="s1"> 
</span><span class="s6">//                });</span><span class="s1"> 
    } 
 
 
    @Override 
    </span><span class="s0">public void </span><span class="s1">onItemClick(BaseSimpleModelAdapter&lt;Bitmap&gt; adapter</span><span class="s0">, int </span><span class="s1">position</span><span class="s0">, </span><span class="s1">Bitmap item) { 
        </span><span class="s0">if </span><span class="s1">(position == mImageAdapter.getItemCount() - </span><span class="s4">1</span><span class="s1">) { 
            showUploadDialog()</span><span class="s0">;</span><span class="s1"> 
        } </span><span class="s0">else </span><span class="s1">{ 
            </span><span class="s0">if</span><span class="s1">(mImageAdapter.urlList.size() &gt; position) { 
                mImageAdapter.urlList.remove(position)</span><span class="s0">; </span><span class="s6">//urlList有可能未上传完成</span><span class="s1"> 
            } 
            mImageAdapter.remove(position)</span><span class="s0">;</span><span class="s1"> 
            mImageAdapter.resetViewHeight(recycler_view</span><span class="s0">, </span><span class="s1">spanCount)</span><span class="s0">;</span><span class="s1"> 
        } 
    } 
 
</span><span class="s6">//    private void showUploadDialog() {</span><span class="s1"> 
</span><span class="s6">//        View view = LayoutInflater.from(this).inflate(R.layout.view_upload_menu, null);</span><span class="s1"> 
</span><span class="s6">//        final Dialog dialog = DialogUtils.showViewDialog(view, true);</span><span class="s1"> 
</span><span class="s6">//</span><span class="s1"> 
</span><span class="s6">//        View.OnClickListener onClickListener = new View.OnClickListener() {</span><span class="s1"> 
</span><span class="s6">//            @Override</span><span class="s1"> 
</span><span class="s6">//            public void onClick(View v) {</span><span class="s1"> 
</span><span class="s6">//                dialog.dismiss();</span><span class="s1"> 
</span><span class="s6">//                int maxNum = mImageAdapter.getCurMaxCount();</span><span class="s1"> 
</span><span class="s6">//                if (maxNum &lt;= 0) {</span><span class="s1"> 
</span><span class="s6">//                    ToastUtil.showMessage(R.string.msg_amount_limit);</span><span class="s1"> 
</span><span class="s6">//                    return;</span><span class="s1"> 
</span><span class="s6">//                }</span><span class="s1"> 
</span><span class="s6">//                switch (v.getId()) {</span><span class="s1"> 
</span><span class="s6">//                    case R.id.camera_button:</span><span class="s1"> 
</span><span class="s6">//                        new PicGetter(_this(), getActivityResultHelper(), _this()).startCamera();</span><span class="s1"> 
</span><span class="s6">//                        break;</span><span class="s1"> 
</span><span class="s6">//                    case R.id.local_button:</span><span class="s1"> 
</span><span class="s6">//                        //new PicGetter(_this(), getActivityResultHelper(), _this()).startImage();</span><span class="s1"> 
</span><span class="s6">//                        selectMultiImage(maxNum);</span><span class="s1"> 
</span><span class="s6">//                        break;</span><span class="s1"> 
</span><span class="s6">//                }</span><span class="s1"> 
</span><span class="s6">//            }</span><span class="s1"> 
</span><span class="s6">//        };</span><span class="s1"> 
</span><span class="s6">//        view.findViewById(R.id.title_text).setVisibility(View.GONE);</span><span class="s1"> 
</span><span class="s6">//        view.findViewById(R.id.camera_button).setOnClickListener(onClickListener);</span><span class="s1"> 
</span><span class="s6">//        view.findViewById(R.id.local_button).setOnClickListener(onClickListener);</span><span class="s1"> 
</span><span class="s6">//        view.findViewById(R.id.cancel_button).setOnClickListener(onClickListener);</span><span class="s1"> 
</span><span class="s6">//    }</span><span class="s1"> 
 
    </span><span class="s0">private void </span><span class="s1">showUploadDialog() { 
        </span><span class="s0">final int </span><span class="s1">maxNum = mImageAdapter.getCurMaxCount()</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">if </span><span class="s1">(maxNum &lt;= </span><span class="s4">0</span><span class="s1">) { 
            ToastUtil.showMessage(R.string.msg_amount_limit)</span><span class="s0">;</span><span class="s1"> 
            </span><span class="s0">return;</span><span class="s1"> 
        } 
        View view = LayoutInflater.from(</span><span class="s0">this</span><span class="s1">).inflate(R.layout.view_bottom_menus</span><span class="s0">, null</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        ItemsLayout itemsLayout = (ItemsLayout) view.findViewById(R.id.layout_items)</span><span class="s0">;</span><span class="s1"> 
        itemsLayout.setDriver()</span><span class="s0">;</span><span class="s1"> 
        itemsLayout.setDriverLeftMargin(</span><span class="s4">0</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">final </span><span class="s1">Dialog dialog = DialogUtils.showViewDialog(view</span><span class="s0">, true</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        itemsLayout.addMenuItem(getString(R.string.take_camera)).setOnClickListener(</span><span class="s0">new </span><span class="s1">View.OnClickListener() { 
            @Override 
            </span><span class="s0">public void </span><span class="s1">onClick(View v) { 
                dialog.dismiss()</span><span class="s0">;</span><span class="s1"> 
                </span><span class="s0">new </span><span class="s1">PicGetter(PublishPostActivity.</span><span class="s0">this, </span><span class="s1">getActivityResultHelper()</span><span class="s0">,</span><span class="s1"> 
                        PublishPostActivity.</span><span class="s0">this</span><span class="s1">).startCropCamera()</span><span class="s0">;</span><span class="s1"> 
            } 
        })</span><span class="s0">;</span><span class="s1"> 
        itemsLayout.addMenuItem(getString(R.string.take_photo)).setOnClickListener(</span><span class="s0">new </span><span class="s1">View.OnClickListener() { 
            @Override 
            </span><span class="s0">public void </span><span class="s1">onClick(View v) { 
                dialog.dismiss()</span><span class="s0">;</span><span class="s1"> 
                selectMultiImage(maxNum)</span><span class="s0">;</span><span class="s1"> 
            } 
        })</span><span class="s0">;</span><span class="s1"> 
        view.findViewById(R.id.btn_cancel).setOnClickListener(</span><span class="s0">new </span><span class="s1">View.OnClickListener() { 
            @Override 
            </span><span class="s0">public void </span><span class="s1">onClick(View v) { 
                dialog.dismiss()</span><span class="s0">;</span><span class="s1"> 
            } 
        })</span><span class="s0">;</span><span class="s1"> 
    } 
 
    </span><span class="s0">private </span><span class="s1">PublishPostActivity _this() { 
        </span><span class="s0">return this;</span><span class="s1"> 
    } 
 
    </span><span class="s0">private </span><span class="s1">ArrayList&lt;String&gt; mSelectPath</span><span class="s0">;</span><span class="s1"> 
 
    </span><span class="s0">private void </span><span class="s1">selectMultiImage(</span><span class="s0">int </span><span class="s1">maxNum) { 
        </span><span class="s0">int </span><span class="s1">selectedMode = MultiImageSelectorActivity.MODE_MULTI</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">boolean </span><span class="s1">showCamera = </span><span class="s0">false;</span><span class="s1"> 
 
        Intent intent = </span><span class="s0">new </span><span class="s1">Intent(</span><span class="s0">this, </span><span class="s1">MultiImageSelectorActivity.</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s6">// 是否显示拍摄图片</span><span class="s1"> 
        intent.putExtra(MultiImageSelectorActivity.EXTRA_SHOW_CAMERA</span><span class="s0">, </span><span class="s1">showCamera)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s6">// 最大可选择图片数量</span><span class="s1"> 
        intent.putExtra(MultiImageSelectorActivity.EXTRA_SELECT_COUNT</span><span class="s0">, </span><span class="s1">maxNum)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s6">// 选择模式</span><span class="s1"> 
        intent.putExtra(MultiImageSelectorActivity.EXTRA_SELECT_MODE</span><span class="s0">, </span><span class="s1">selectedMode)</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s6">// 默认选择</span><span class="s1"> 
        </span><span class="s0">if </span><span class="s1">(mSelectPath != </span><span class="s0">null </span><span class="s1">&amp;&amp; mSelectPath.size() &gt; </span><span class="s4">0</span><span class="s1">) { 
            intent.putExtra(MultiImageSelectorActivity.EXTRA_DEFAULT_SELECTED_LIST</span><span class="s0">, </span><span class="s1">mSelectPath)</span><span class="s0">;</span><span class="s1"> 
        } 
        startActivityForResult(intent</span><span class="s0">, new </span><span class="s1">ActivityResult() { 
            @Override 
            </span><span class="s0">public void </span><span class="s1">onActivityResult(Intent data) { 
                mSelectPath = data.getStringArrayListExtra(MultiImageSelectorActivity.EXTRA_RESULT)</span><span class="s0">;</span><span class="s1"> 
                onPicGets()</span><span class="s0">;</span><span class="s1"> 
            } 
        })</span><span class="s0">;</span><span class="s1"> 
    } 
 
    </span><span class="s2">/** 
     * 选择照片后的回调接口的实现 
     */</span><span class="s1"> 
    </span><span class="s0">public void </span><span class="s1">onPicGets() { 
        ArrayList&lt;Bitmap&gt; mSelectBitmap = </span><span class="s0">new </span><span class="s1">ArrayList&lt;&gt;()</span><span class="s0">;</span><span class="s1"> 
        mImageAdapter.removeAll()</span><span class="s0">;</span><span class="s1"> 
        </span><span class="s0">for </span><span class="s1">(String p : mSelectPath) { 
            Bitmap bitmap = PicGetter.decodeBitmapFromPath(p)</span><span class="s0">;</span><span class="s1"> 
            mSelectBitmap.add(bitmap)</span><span class="s0">;</span><span class="s1"> 
            mImageAdapter.addImage(bitmap)</span><span class="s0">;</span><span class="s1"> 
        } 
        mImageAdapter.resetViewHeight(recycler_view</span><span class="s0">, </span><span class="s1">spanCount)</span><span class="s0">;</span><span class="s1"> 
    } 
 
    </span><span class="s0">public void </span><span class="s1">uploadImage(</span><span class="s0">final int </span><span class="s1">index) { 
        </span><span class="s0">if </span><span class="s1">(mSelectPath.size() &lt;= </span><span class="s4">0</span><span class="s1">) { 
            </span><span class="s6">//dismissProgressDialog();</span><span class="s1"> 
            </span><span class="s6">//ToastUtil.showMessage(mImageAdapter.urlList.toString());</span><span class="s1"> 
            post()</span><span class="s0">;</span><span class="s1"> 
            </span><span class="s0">return;</span><span class="s1"> 
        } 
        Bitmap bitmap = mImageAdapter.getItem(index)</span><span class="s0">;</span><span class="s1"> 
        String path = mSelectPath.get(</span><span class="s4">0</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
        UploadImageBiz.uploadImage(UPLOAD_TYPE</span><span class="s0">, </span><span class="s1">bitmap</span><span class="s0">, new </span><span class="s1">File(path).getName()</span><span class="s0">,</span><span class="s1"> 
                </span><span class="s0">new </span><span class="s1">ResponseListener&lt;ImageUploadResp&gt;() { 
                    @Override 
                    </span><span class="s0">public void </span><span class="s1">onResponse(ImageUploadResp o) { 
                        mImageAdapter.urlList.add(HttpConfig.IMAGE_SHOW_URL + o.url)</span><span class="s0">;</span><span class="s1"> 
                        mSelectPath.remove(</span><span class="s4">0</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
                        uploadImage(index + </span><span class="s4">1</span><span class="s1">)</span><span class="s0">;</span><span class="s1"> 
                    } 
 
                    @Override 
                    </span><span class="s0">public void </span><span class="s1">onErrorResponse(VolleyError error) { 
                        </span><span class="s6">//dismissProgressDialog();</span><span class="s1"> 
                        </span><span class="s0">super</span><span class="s1">.onErrorResponse(error)</span><span class="s0">;</span><span class="s1"> 
                    } 
                })</span><span class="s0">;</span><span class="s1"> 
    } 
}</span></pre>
</body>
</html>